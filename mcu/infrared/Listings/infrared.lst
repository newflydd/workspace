C51 COMPILER V9.56.0.0   INFRARED                                                          05/13/2017 00:09:20 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE INFRARED
OBJECT MODULE PLACED IN .\Objects\infrared.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE infrared.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\
                    -infrared.lst) TABS(2) OBJECT(.\Objects\infrared.obj)

line level    source

   1          /**
   2           * å°†çº¢å¤–æ•°æ®æ¥æ”¶åˆ°åï¼Œå‘å¾€UART
   3           * è®¡æ—¶ä½¿ç”¨å®šæ—¶å™¨T0
   4           * UARTä½¿ç”¨å®šæ—¶å™¨T1
   5           */
   6          
   7          #include "infrared.h"
   8          #include "intrins.h"
   9          
  10          uchar idata buffer[128];
  11          uchar bufferLength = 0;
  12          volatile unsigned char sending;
  13          //C3 E0 00 00 05 00 00 00 00 04 00 A0 F1
  14          //C3 E0 00 00 05 00 00 00 00 00 00 A0 F6 
  15          uchar sendCmd1[] = {0xC3, 0xE0, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0xA0, 0xF1};
  16          uchar sendCmd2[] = {0xC3, 0xE0, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA0, 0xF6};
  17          uchar sendIndex = 1;
  18          
  19          sbit  SendDataPin = P1^5; /* å®šä¹‰çº¢å¤–å‘å°„å¼€å…³å¼•è„š */
  20          sbit  SendCmdPin  = P1^6; /* å®šä¹‰å‘å°„æŒ‰é’®å¾®åŠ¨å¼€å…³å¼•è„šï¼Œä¸Šæ‹‰ç”µé˜»ç»´æŒé«˜ç”µå¹³ï¼Œå¾®åŠ¨æŒ
             -‰ä¸‹æœ‰ä¸ªä¸‹é™æ²¿è§¦å‘ */
  21          uchar canSend     = 1;    /* è¡¨ç¤ºæ˜¯å¦å¯ä»¥æ¥æ”¶å‘é€æŒ‡ä»¤ï¼Œä¸Šå‡æ²¿åæ‰å¯å‘é€ */
  22          
  23          uint  uintBuffer;
  24          uchar ucharBuffer;
  25          uchar shake;        /* å»æŠ–å˜é‡ */
  26          
  27          void InitBuffer(){
  28   1        uchar i;
  29   1        for(i = 0; i < 128; i++){
  30   2          buffer[i] = 0x00;
  31   2        }
  32   1      }
  33          
  34          void main(){
  35   1        EA = 1;       /* æ€»ä¸­æ–­ä½¿èƒ½ */
  36   1        canSend = 1;
  37   1        
  38   1        InitBuffer();
  39   1        InitInfrared();
  40   1        InitUART();
  41   1      
  42   1        while(1){
  43   2          /* å¾®åŠ¨å¼€å…³å¼•è„šç½®ä½ï¼Œä¿è¯å…¶å¯è¯» */
  44   2          SendCmdPin = 1;
  45   2      
  46   2          ucharBuffer = SendCmdPin;
  47   2      
  48   2          /* ç¬¬ä¸€é˜¶æ®µï¼ŒcanSendç½®ä½ */
  49   2          if(canSend == 0 && SendCmdPin == 1){
  50   3            /* ä¸å¯å‘é€æ—¶ï¼Œæ¥æ”¶åˆ°ä¸Šå‡ä¿¡å·ï¼Œæ­¤æ—¶canSendç½®ä¸ºå¯å‘é€ */
  51   3            shake = 10;
  52   3            while(SendCmdPin && shake){
  53   4              shake--;
C51 COMPILER V9.56.0.0   INFRARED                                                          05/13/2017 00:09:20 PAGE 2   

  54   4            }
  55   3            if(!shake)              /* å»æŠ– */
  56   3              canSend = 1;
  57   3            continue;
  58   3          }
  59   2      
  60   2          /* ç¬¬äºŒé˜¶æ®µï¼Œå‘é€çº¢å¤– */
  61   2          if(canSend == 1 && SendCmdPin == 0){
  62   3            shake = 10;
  63   3            while(!SendCmdPin && shake){
  64   4              shake--;
  65   4            }
  66   3            if(!shake){             /* å»æŠ– */
  67   4              canSend = 0;
  68   4              SendInfraredSignal();
  69   4            }
  70   3            continue;
  71   3          }
  72   2        }
  73   1      }
  74          
  75          /**
  76           * interrupt 0 : å¤–éƒ¨ä¸­æ–­0 P3.2
  77           * interrupt 1 : å®šæ—¶å™¨ä¸­æ–­0
  78           * interrupt 2 : å¤–éƒ¨ä¸­æ–­1 P3.3
  79           * interrupt 3 : å®šæ—¶å™¨ä¸­æ–­1
  80           * interrupt 4 : ä¸²å£ä¸­æ–­
  81           */
  82          void EXINT1_ISR() interrupt 2{
  83   1        uchar j;
  84   1        uint  time;
  85   1      
  86   1        time = GetLowTime();
  87   1        if(time < 7833 || time > 8755){       /* åˆ¤æ–­æ˜¯å¦åœ¨9msä»¥å†… */
  88   2          IE1 = 0;
  89   2          return;
  90   2        }
  91   1      
  92   1        time = GetHighTime();
  93   1        if(time < 3686 || time > 4608){       /* åˆ¤æ–­æ˜¯å¦åœ¨4.5msä»¥å†… */
  94   2          IE1 = 0;
  95   2          return; 
  96   2        }
  97   1      
  98   1        /* æ¥æ”¶çº¢å¤–å­—èŠ‚ï¼Œç›´åˆ°é«˜ç”µå¹³æ—¶é—´é•¿äº1751ï¼Œå»¶æ—¶ä¸€ä¼šå„¿å‘é€UART */
  99   1        while(1){
 100   2          for(j = 0; j < 8; j++){
 101   3            time = GetLowTime();
 102   3            if(time < 313 || time > 718){       /* åˆ¤æ–­æ˜¯å¦æ˜¯560us */
 103   4              IE1 = 0;
 104   4              return;
 105   4            }
 106   3            time = GetHighTime();
 107   3            if(time > 313 && time < 718){       /* æ¥æ”¶åˆ°äº†0 */
 108   4              buffer[bufferLength] = buffer[bufferLength] << 1;
 109   4            }else if(time > 1345 && time < 1751){   /* æ¥æ”¶åˆ°äº†1 */
 110   4              buffer[bufferLength] = buffer[bufferLength] << 1;
 111   4              buffer[bufferLength] |= 0x01;
 112   4            }else{                    /* >=1751æ—¶è¡¨ç¤ºç»“æŸä½ï¼Œæ— ä¿¡å·äº† */
 113   4              IE1 = 0;
 114   4              uintBuffer = 5000;
 115   4              while(uintBuffer--);
C51 COMPILER V9.56.0.0   INFRARED                                                          05/13/2017 00:09:20 PAGE 3   

 116   4      
 117   4              for(ucharBuffer = 0; ucharBuffer < bufferLength; ucharBuffer++){
 118   5                SBUF = buffer[ucharBuffer];
 119   5                sending = 1;
 120   5                while(sending);   /* å‘é€æ¯ä¸ªå­—èŠ‚åéƒ½ç­‰UARTä¸­æ–­ä¸­å°†sendingå¤ä½ï¼Œé˜²æ­¢é”™ä¹± */
 121   5              }     
 122   4      
 123   4              bufferLength = 0;
 124   4              return;
 125   4            }
 126   3          }
 127   2      
 128   2          bufferLength++;
 129   2        }
 130   1      }
 131          
 132          /**
 133           * å»¶æ—¶å¾®ç§’çº§åˆ«ï¼Œå…¬å¼ä¸ºå»¶æ—¶çš„å¾®ç§’æ•°å€¼ * 0.9215
 134           * @param ns [description]
 135           */
 136          void delay(uint us){
 137   1        while(us)us--;
 138   1      }
 139          
 140          uint GetHighTime(){
 141   1        TH0 = 0;
 142   1        TL0 = 0;        /* è®¡æ•°å™¨çš„é«˜ä½4ä½ï¼Œåˆå§‹è®¾ä¸º0 */
 143   1      
 144   1        TR0 = 1;        /* è®¡æ•°å™¨è®¡æ—¶ä½¿èƒ½ */
 145   1        while(IR_INPUT){
 146   2          if(TH0 > 0x40)    /* å¦‚æœé«˜4ä½å¤§äºæŸä¸€é˜ˆå€¼ï¼Œè¡¨ç¤ºå¼‚å¸¸ */
 147   2            break;
 148   2        }
 149   1        TR0 = 0;        /* è®¡æ•°å™¨å¤±èƒ½ */
 150   1        return TH0 * 256 + TL0; /* é«˜4ä½*256 + ä½4ä½ = è®¡æ—¶å¼€å§‹åè·‘è¿‡çš„æ—¶é—´ */
 151   1      }
 152          
 153          uint GetLowTime(){
 154   1        TH0 = 0;
 155   1        TL0 = 0;        /* è®¡æ•°å™¨çš„é«˜ä½4ä½ï¼Œåˆå§‹è®¾ä¸º0 */
 156   1      
 157   1        TR0 = 1;        /* è®¡æ•°å™¨è®¡æ—¶ä½¿èƒ½ */
 158   1        while(!IR_INPUT){
 159   2          if(TH0 > 0x40)    /* å¦‚æœé«˜4ä½å¤§äºæŸä¸€é˜ˆå€¼ï¼Œè¡¨ç¤ºå¼‚å¸¸ */
 160   2            break;
 161   2        }
 162   1        TR0 = 0;        /* è®¡æ•°å™¨å¤±èƒ½ */
 163   1        return TH0 * 256 + TL0; /* é«˜4ä½*256 + ä½4ä½ = è®¡æ—¶å¼€å§‹åè·‘è¿‡çš„æ—¶é—´ */
 164   1      }
 165          
 166          /**
 167           * è®¡æ—¶ä½¿ç”¨T0
 168           */
 169          void InitInfrared(){
 170   1        IR_INPUT = 1;
 171   1      
 172   1        TMOD &= 0xF0;
 173   1        TMOD |= 0x01;       /* å°†TMOD é«˜4ä½ä¸å˜ï¼Œä½4ä½ç½®0001ï¼Œä½¿èƒ½å®šæ—¶å™¨T0 */
 174   1      
 175   1        TR0 = 0;          /* TR:è®¡æ—¶ä½¿èƒ½ï¼Œç½®1è®¡æ—¶ï¼Œç½®0åœæ­¢ */
 176   1        ET0 = 0;          /* ET:å®šæ—¶å™¨ä¸­æ–­ä½¿èƒ½ï¼Œç½®1ä½¿èƒ½ï¼Œç½®0å¤±èƒ½ */
 177   1        IT1 = 1;          /* IT:å¤–éƒ¨ä¸­æ–­æ–¹å¼é€‰æ‹©ï¼Œ0:ä½ç”µå¹³è§¦å‘ï¼Œ1:ä¸‹é™æ²¿è§¦å‘ */
C51 COMPILER V9.56.0.0   INFRARED                                                          05/13/2017 00:09:20 PAGE 4   

 178   1        EX1 = 1;          /* EX:å¤–éƒ¨ä¸­æ–­ä½¿èƒ½ï¼Œ1:ä½¿èƒ½ï¼Œ0:å¤±èƒ½ */
 179   1      
 180   1        SendCmdPin = 1;       /* å¾®åŠ¨å¼€å…³å¼•è„šç½®1ï¼Œä¸Šæ‹‰ç”µé˜»ç»´æŒï¼Œä¿è¯å…¶å¯è¯» */
 181   1        SendDataPin = 0;      /* å‘å°„å¼€å…³ç½®0ï¼Œç»´æŒä½ç”µå¹³è¾“å‡º */
 182   1      }
 183          
 184          /**
 185           * ä¸²å£é€šä¿¡ä½¿ç”¨å®šæ—¶å™¨T1
 186           */
 187          void InitUART(){
 188   1        SCON =  0x50;
 189   1        
 190   1        TMOD |= 0x20;
 191   1        TMOD &= 0xEF;   //è®¾ç½®å®šæ—¶å™¨1ï¼Œå·¥ä½œåœ¨2æ¨¡å¼ï¼Œä¸²å£ä¸­æ–­ä½¿ç”¨
 192   1        
 193   1        TH1 = 0xFD;
 194   1        TL1 = 0xFD;     //æ³¢ç‰¹ç‡9600
 195   1        
 196   1        TR1 = 1;      //TCONä¸­çš„TR1ï¼Œå®šæ—¶å™¨1å¼€å§‹è®¡æ—¶
 197   1        ES  = 1;      //ä¸²å£ä¸­æ–­æ‰“å¼€
 198   1      
 199   1        IP = 0x10;
 200   1      }
 201          
 202          void UartInterrupt() interrupt 4{
 203   1        if(TI){       //æœ¬æ¬¡ä¸­æ–­æ˜¯å‘é€ä¸­æ–­
 204   2          TI = 0;     //å‘é€å®Œäº†æ¸…é›¶
 205   2          REN = 1;    //å‘é€å®Œäº†å†æ¥å—
 206   2          sending = 0;  //æ¸…ç©ºå‘å°„æ ‡å¿—
 207   2        }
 208   1      }
 209          
 210          /**
 211           * çº¢å¤–å‘å°„ä¸€ä¸ªå­—èŠ‚ï¼Œä»é«˜ä½å‘ä½ä½å‘å°„
 212           * 0ï¼š 560usé«˜ç”µå¹³ï¼Œ560usä½ç”µå¹³
 213           * 1ï¼š 560usé«˜ç”µå¹³ï¼Œ1690usä½ç”µå¹³
 214           */
 215          void sendInfraredByte(uchar dat){
 216   1        uchar pos2;
 217   1      
 218   1        for(pos2 = 0; pos2 < 8; pos2++){
 219   2          if((dat & (0x80 >> pos2)) == 0x00){
 220   3            /* å‘å°„0 */
 221   3            SendDataPin = 1;
 222   3            delay(65);
 223   3            SendDataPin = 0;
 224   3            delay(65);
 225   3            SendDataPin = 1;
 226   3          }else{
 227   3            /* å‘å°„1 */
 228   3            SendDataPin = 1;
 229   3            delay(65);
 230   3            SendDataPin = 0;
 231   3            delay(190);
 232   3            SendDataPin = 1;
 233   3          }
 234   2        }
 235   1      }
 236          
 237          /* å‘å°„çº¢å¤–ä¿¡å· */
 238          void SendInfraredSignal(){
 239   1        uchar pos;
C51 COMPILER V9.56.0.0   INFRARED                                                          05/13/2017 00:09:20 PAGE 5   

 240   1        char* sendCmd;
 241   1      
 242   1        if(sendIndex == 0){
 243   2          sendIndex = 1;
 244   2          sendCmd = sendCmd1;
 245   2        }else{
 246   2          sendIndex = 0;
 247   2          sendCmd = sendCmd2;
 248   2        }
 249   1      
 250   1        EX1 = 0;
 251   1      
 252   1        /* 9msé«˜ç”µå¹³ */
 253   1        SendDataPin = 1;
 254   1        delay(1040);
 255   1      
 256   1        /* 4.5msä½ç”µå¹³ */
 257   1        SendDataPin = 0;
 258   1        delay(510);
 259   1      
 260   1        /**
 261   1         * æŒ‰ç…§æ•°ç»„ä¸­çš„æ•°æ®ä¾æ¬¡å‘å¤–å‘å°„
 262   1         */
 263   1        for(pos = 0; pos < 13; pos++){
 264   2          sendInfraredByte(sendCmd[pos]);
 265   2        }
 266   1      
 267   1        SendDataPin = 1;
 268   1        delay(65);
 269   1        SendDataPin = 0;
 270   1      
 271   1        EX1 = 1;
 272   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    669    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     34       5
   IDATA SIZE       =    128    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
